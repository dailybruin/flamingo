import React, { Component } from 'react'
import MainSiteFooter from '@dailybruin/lux/src/components/MainSiteFooter'
import MainSiteHeader from '@dailybruin/lux/src/components/MainSiteHeader'
import { Page } from 'csstype'
import { Config } from '../config.js'
import fetch from 'isomorphic-unfetch'

import { graphql } from 'react-apollo'
import gql from 'graphql-tag'

const topBarLinks = gql`
  {
    menu(id: "TWVudTo4") {
      count
      id
      menuId
      name
      slug
      menuItems {
        edges {
          node {
            url
            label
          }
        }
      }
    }
  }
`

const layoutStyle = {
  maxWidth: 1200,
  margin: 'auto'
};

const PageWrapper = Comp =>
  class extends Component {
    static async getInitialProps(ctx) {

      // Load the categories for the header
      // TODO: can we load this once each browser session?
      // only call getInitialProps if the child has that function
      const [childProps, categoriesRes] = await Promise.all([
        Comp.getInitialProps ? Comp.getInitialProps(ctx) : null,
        fetch(
          `${Config.apiUrl}/wp-json/wp/v2/categories`
        ),
      ]);

      const categories = await categoriesRes.json();
      const mappedCategories = categories.map(index => {
        return ({category: index.name, categoryURL: '/category/' + index.slug})
      })

      return {
        ...(Comp.getInitialProps ? childProps : null),
        mappedCategories
      };
    }

    render() {
      return (
        <div style={layoutStyle}>
          <MainSiteHeader links={this.props.mappedCategories} />
          <Comp {...this.props}/>
          <MainSiteFooter />
        </div>
      );

    }
  }

export default PageWrapper
